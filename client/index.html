<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <script>
      // Disable problematic Vite HMR and implement fallback refresh mechanism
      if (typeof window !== 'undefined') {
        // Disable HMR by setting environment flag
        window.__vite_is_modern_browser = false;
        
        // Override WebSocket constructor to handle application WebSockets but disable HMR
        const OriginalWebSocket = window.WebSocket;
        window.WebSocket = function(url, protocols) {
          if (typeof url === 'string') {
            console.log('WebSocket connection attempt:', url);
            
            // Block Vite HMR connections that are causing issues
            if (url.includes('token=') && url.includes('localhost:undefined')) {
              console.log('Blocking problematic HMR connection');
              // Return a mock WebSocket that doesn't actually connect
              return {
                close: () => {},
                send: () => {},
                addEventListener: () => {},
                removeEventListener: () => {},
                dispatchEvent: () => {},
                readyState: 3, // CLOSED
                CONNECTING: 0,
                OPEN: 1,
                CLOSING: 2,
                CLOSED: 3
              };
            }
            
            // Fix application WebSocket URLs (like /ws endpoint)
            if (url.includes(':undefined')) {
              url = url.replace(':undefined', ':' + (window.location.port || '5000'));
            }
            
            if (url.includes('localhost') && window.location.hostname !== 'localhost') {
              url = url.replace('localhost', window.location.hostname);
            }
            
            if (window.location.protocol === 'https:' && url.startsWith('ws:')) {
              url = url.replace('ws:', 'wss:');
            }
            
            console.log('WebSocket URL:', url);
          }
          return new OriginalWebSocket(url, protocols);
        };
        
        // Copy static properties
        Object.setPrototypeOf(window.WebSocket, OriginalWebSocket);
        window.WebSocket.prototype = OriginalWebSocket.prototype;
        window.WebSocket.CONNECTING = 0;
        window.WebSocket.OPEN = 1;
        window.WebSocket.CLOSING = 2;
        window.WebSocket.CLOSED = 3;
        
        // Simple file change detection via periodic checks
        let lastModified = Date.now();
        setInterval(() => {
          fetch('/?_=' + Date.now(), { method: 'HEAD' })
            .then(response => {
              const modified = response.headers.get('last-modified');
              if (modified && new Date(modified).getTime() > lastModified) {
                console.log('Files changed, refreshing page...');
                window.location.reload();
              }
            })
            .catch(() => {}); // Ignore errors
        }, 2000);
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>